<!doctype html>
<html>
  <head>
    <title>lib/file.js [ Indoc ]</title>
    <link rel="stylesheet" href="./../../public/style.css" />
    <script src="./../../public/jquery.min.js"></script>
    <script src="./../../public/script.js"></script>
  </head>
  <body class="code">
    
    <main id="sections">

      <!-- The header -->

      <section class="section header files-hidden" id="header">

        <aside class="comment">

          <header>

            <div class="file-path">
              
              <a id="project-overview" href="./../.." title="Project Overview">Indoc</a>
              
              <div class="files-menu">
                <span id="filename">lib/file.js</span>
                
                <ul class="files hidable">
                  
                  <li class="file"><a href="./../../README.md/">README.md</a></li>
                  <li class="file"><a href="./../../bin/main.js/">bin/main.js</a></li>
                  <li class="file"><a href="./../../examples/example.c/">examples/example.c</a></li>
                  <li class="file"><a href="./../../examples/example.js/">examples/example.js</a></li>
                  <li class="file"><a href="./../../examples/example.s/">examples/example.s</a></li>
                  <li class="file"><a href="./../../lib/class.js/">lib/class.js</a></li>
                  <li class="file"><a href="./../../lib/language.js/">lib/language.js</a></li>
                  <li class="file"><a href="./../../lib/main.js/">lib/main.js</a></li>
                  <li class="file"><a href="./../../lib/section.js/">lib/section.js</a></li>
                  
                </ul>
                
              </div>
                
            </div>

            <div class="spacer"></div>
            
          </header>
            
        </aside>

        <div class="code empty">
        </div>
        
      </section>

      <!-- The main code section -->
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"></div>
        </aside>

        <div class="code">
          <pre><code><span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs-extra'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> merge = <span class="hljs-built_in">require</span>(<span class="hljs-string">'merge'</span>);

<span class="hljs-keyword">var</span> c = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./class'</span>).class;
<span class="hljs-keyword">var</span> auto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'run-auto'</span>);
<span class="hljs-keyword">var</span> section = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./section'</span>).section;
<span class="hljs-keyword">var</span> language = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./language'</span>);
<span class="hljs-keyword">var</span> detect = <span class="hljs-built_in">require</span>(<span class="hljs-string">'language-detect'</span>);

exports.file = c.extend({

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>The file needs access to the <code>project</code> for options and the
templates.</p>
</div>
        </aside>

        <div class="code">
          <pre><code>  init: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">project, filename</span>) </span>{
    <span class="hljs-keyword">this</span>.project = project;
    
    <span class="hljs-keyword">this</span>.filename = filename;
    <span class="hljs-keyword">this</span>.sections = [];

    <span class="hljs-keyword">this</span>.html = <span class="hljs-string">''</span>;
  },

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>Does nothing at the moment.</p>
</div>
        </aside>

        <div class="code">
          <pre><code>  preprocess_file: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, callback</span>) </span>{
    callback(<span class="hljs-literal">null</span>, data);
  },

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>Split up the input by newlines and call the callback.</p>
</div>
        </aside>

        <div class="code">
          <pre><code>  split_lines: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, callback</span>) </span>{
    <span class="hljs-keyword">var</span> lines = data.split(<span class="hljs-regexp">/\r?\n/</span>);

    callback(<span class="hljs-literal">null</span>, lines);
  },

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>Detect the programming language. (Currently, only uses the file
extension.)</p>
</div>
        </aside>

        <div class="code">
          <pre><code>  detect_language: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, callback</span>) </span>{
    <span class="hljs-keyword">var</span> scope = <span class="hljs-keyword">this</span>;
    
    detect(<span class="hljs-keyword">this</span>.filename, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, lang</span>) </span>{
      
      <span class="hljs-keyword">var</span> l = language.language.create(scope.project, scope, lang);
      scope.language = l;
      callback(err, l);
      
    });
    
  },

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>The meat of the program: parsing lines.</p>
</div>
        </aside>

        <div class="code">
          <pre><code>  parse_lines: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, lang, callback</span>) </span>{

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>See <a href="../section.js">section.js</a>.</p>
</div>
        </aside>

        <div class="code">
          <pre><code>    <span class="hljs-keyword">var</span> sections = [];

    <span class="hljs-keyword">var</span> scope = <span class="hljs-keyword">this</span>;
    
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add_section</span>(<span class="hljs-params"></span>) </span>{
      
</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>We don&#39;t want to create a new section if the current one is empty anyway.</p>
</div>
        </aside>

        <div class="code">
          <pre><code>      <span class="hljs-keyword">if</span>(sections.length == <span class="hljs-number">0</span> || !current_section().is_empty()) {
        sections.push(section.create(scope.project, scope, lang));
      }
      
    }

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>Start off with an empty section.</p>
</div>
        </aside>

        <div class="code">
          <pre><code>    add_section();

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>Just a convenience function.</p>
</div>
        </aside>

        <div class="code">
          <pre><code>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">current_section</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> sections[sections.length<span class="hljs-number">-1</span>];
    }

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p><code>in_comment</code> is self explanatory. That&#39;s why I&#39;m explaining it
to you right now by saying it&#39;s self explanatory. Hey, if I was
smart, I&#39;d be working at <a href="http://www.spacex.com/">SpaceX</a>. Or
something.</p>
</div>
        </aside>

        <div class="code">
          <pre><code>    <span class="hljs-keyword">var</span> in_comment = <span class="hljs-literal">false</span>,
        in_multi = <span class="hljs-literal">false</span>,
        line,
        comment,
        i;

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p><code>for(line in data) { ...</code></p>
</div>
        </aside>

        <div class="code">
          <pre><code>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;data.length; i++) {
      line = data[i];

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>... if that line is a comment...</p>
</div>
        </aside>

        <div class="code">
          <pre><code>      <span class="hljs-keyword">if</span>(lang.is_comment(line) || (in_multi &amp;&amp; lang.is_in_multi_comment(line))) {

        <span class="hljs-keyword">if</span>(lang.is_multi_comment(line))
          in_multi = <span class="hljs-literal">true</span>;

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>... then strip the whitespace from it...</p>
</div>
        </aside>

        <div class="code">
          <pre><code>        comment = lang.strip_comment(line);

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>... and add a new section, if necessary.</p>
</div>
        </aside>

        <div class="code">
          <pre><code>        <span class="hljs-keyword">if</span>(!in_comment)
          add_section();

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>Then append the line to the current section&#39;s comment, with
a newline (to replace the one lost with the split, above.)</p>
</div>
        </aside>

        <div class="code">
          <pre><code>        current_section().comment += comment + <span class="hljs-string">'\n'</span>;

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>We&#39;re obviously in a comment now.</p>
</div>
        </aside>

        <div class="code">
          <pre><code>        in_comment = <span class="hljs-literal">true</span>;
        
      } <span class="hljs-keyword">else</span> {
        
        in_comment = <span class="hljs-literal">false</span>;
        in_multi = <span class="hljs-literal">false</span>;

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>This is a bit strange: if we&#39;re currently on our first
section, <em>and</em> the code is empty, <em>and</em> the line is empty,
then ignore it.  Basically, this chops off the whitespace
at the start of a file.</p>
</div>
        </aside>

        <div class="code">
          <pre><code>        <span class="hljs-keyword">if</span>(sections.length == <span class="hljs-number">1</span> &amp;&amp; !current_section().code.trim() &amp;&amp; !line.trim()) <span class="hljs-keyword">continue</span>;

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>If there&#39;s a space after the comment, we want to ignore
it. (Otherwise, the tops of the code and the comments won&#39;t
be lined up and it&#39;ll be harder to match them up.)</p>
</div>
        </aside>

        <div class="code">
          <pre><code>        <span class="hljs-keyword">if</span>(!current_section().code.trim() &amp;&amp; !line.trim()) <span class="hljs-keyword">continue</span>;

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>Same as above: we need to replace the missing newline.</p>
</div>
        </aside>

        <div class="code">
          <pre><code>        current_section().code += line + <span class="hljs-string">'\n'</span>;
      }
      
    };

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>This just syntax-highlights the code and converts the Markdown
comments to HTML.</p>
</div>
        </aside>

        <div class="code">
          <pre><code>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;sections.length; i++) {
      sections[i].done();
    }

    <span class="hljs-keyword">this</span>.sections = sections;

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>And we&#39;re done here! Whew.</p>
</div>
        </aside>

        <div class="code">
          <pre><code>    callback(<span class="hljs-literal">null</span>, sections);
    
  },

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>This function just invokes Handlebars to produce the HTML output.</p>
</div>
        </aside>

        <div class="code">
          <pre><code>  generate_output: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">sections, language, index, callback</span>) </span>{

    <span class="hljs-keyword">if</span>(!callback) {
      callback = index;
      index = <span class="hljs-literal">undefined</span>;
    }

    <span class="hljs-keyword">if</span>(index == <span class="hljs-literal">undefined</span>) index = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span>(!sections) sections = <span class="hljs-keyword">this</span>.sections;
    <span class="hljs-keyword">if</span>(!language) language = <span class="hljs-keyword">this</span>.language;

    <span class="hljs-keyword">var</span> i;

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>Relative path to the output root, in filesystem-space.  For the
file <code>docs/foo/bar/</code>, <code>rel_path</code> would be <code>./../../</code>. It&#39;s used
for inter-file linking and CSS/JS.</p>
</div>
        </aside>

        <div class="code">
          <pre><code>    <span class="hljs-keyword">var</span> rel_path = <span class="hljs-string">'./'</span> + path.relative(<span class="hljs-string">'/'</span> + <span class="hljs-keyword">this</span>.get_link(), <span class="hljs-string">'/'</span>);

    <span class="hljs-keyword">if</span>(index) rel_path = <span class="hljs-string">'.'</span>;

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>Get a list of all of the other files&#39; filenames and URLs except
this one.</p>
</div>
        </aside>

        <div class="code">
          <pre><code>    <span class="hljs-keyword">var</span> filenames = <span class="hljs-keyword">this</span>.project.get_link_filenames(<span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">if</span>(index) filenames = <span class="hljs-keyword">this</span>.project.get_link_filenames();

    <span class="hljs-keyword">var</span> md = <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">if</span>(sections.length == <span class="hljs-number">1</span> &amp;&amp; sections[<span class="hljs-number">0</span>].code_is_markdown) {
      md = sections[<span class="hljs-number">0</span>].code_highlighted;
    }

    <span class="hljs-keyword">var</span> classes = [];

    <span class="hljs-keyword">if</span>(index) classes.push(<span class="hljs-string">'index'</span>);
    <span class="hljs-keyword">else</span>      classes.push(<span class="hljs-string">'code'</span>);
    
    <span class="hljs-keyword">if</span>(md) classes.push(<span class="hljs-string">'markdown'</span>);

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>HANDLEBARS, DO YOUR THING!</p>
</div>
        </aside>

        <div class="code">
          <pre><code>    <span class="hljs-keyword">var</span> page = <span class="hljs-keyword">this</span>.project.templates.page(merge(<span class="hljs-keyword">this</span>.project.default_template_data, {
      title: (index ? <span class="hljs-keyword">this</span>.project.options.name : <span class="hljs-keyword">this</span>.filename),
      markdown: md,
      filename: <span class="hljs-keyword">this</span>.filename,
      files: filenames,
      path: rel_path,
      index: index,
      classes: classes.join(<span class="hljs-string">' '</span>),
      sections: sections
    }));
    
    callback(<span class="hljs-literal">null</span>, page);
  },

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>Get the output filename, in filesystem-space. For <code>bin/main.js</code>,
this returns <code>docs/bin/main.js/index.html</code></p>
</div>
        </aside>

        <div class="code">
          <pre><code>  get_output_filename: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> path.join(<span class="hljs-keyword">this</span>.project.options.output, <span class="hljs-keyword">this</span>.filename, <span class="hljs-string">'index.html'</span>);
  },

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>Same as above, but server-space. With <code>bin/main.js</code>, this returns
<code>bin/main.js/</code>. It&#39;s used for pretty links in <code>&lt;a&gt;</code> tags.</p>
</div>
        </aside>

        <div class="code">
          <pre><code>  get_link: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.filename + <span class="hljs-string">'/'</span>;
  },

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>Write the generated file.</p>
</div>
        </aside>

        <div class="code">
          <pre><code>  write: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">output, filename, callback</span>) </span>{

    <span class="hljs-keyword">if</span>(!output) {
      output = <span class="hljs-keyword">this</span>.html;
    }

    <span class="hljs-keyword">if</span>(!callback) {
      callback = filename;
      filename = <span class="hljs-keyword">this</span>.get_output_filename();
    }

    <span class="hljs-keyword">var</span> scope = <span class="hljs-keyword">this</span>;

    fs.mkdirs(path.dirname(filename), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
      <span class="hljs-keyword">if</span>(err) {
        callback(err, <span class="hljs-literal">null</span>);
        <span class="hljs-keyword">return</span>;
      }

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>Yeah, yeah, I know, callback hell. What&#39;s the harm in using it once?</p>
</div>
        </aside>

        <div class="code">
          <pre><code>      fs.writeFile(filename, output, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
        
        <span class="hljs-keyword">if</span>(err) {
          callback(err, <span class="hljs-literal">null</span>);
          <span class="hljs-keyword">return</span>;
        }

        callback(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);

      });      
      
    });


  },

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>A mega-function that calls most of the above functions, in the
proper order thanks to <code>run-auto</code>.</p>
</div>
        </aside>

        <div class="code">
          <pre><code>  parse_file: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data, callback</span>) </span>{

    <span class="hljs-keyword">var</span> scope = <span class="hljs-keyword">this</span>;

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>This is weird. I&#39;m not sure why it&#39;s here instead of up there,
but I&#39;m sure there&#39;s some reason. I don&#39;t change strange things
like this when I find them for fear of causing my programs to
explode with errors.</p>
</div>
        </aside>

        <div class="code">
          <pre><code>    <span class="hljs-keyword">if</span>(err) {
      callback(err, <span class="hljs-keyword">this</span>);
      <span class="hljs-keyword">return</span>;
    }

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>See above: <code>var auto = require(&#39;run-auto&#39;);</code></p>
</div>
        </aside>

        <div class="code">
          <pre><code>    auto({
      
      preprocess: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">next</span>) </span>{
        scope.preprocess_file.call(scope, data, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{

          next(err, data);
          
        });
      },
      
      split_lines: [<span class="hljs-string">'preprocess'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">next, results</span>) </span>{
        
        scope.split_lines.call(scope, results.preprocess, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
          
          next(err, data);
          
        });
          
      }],
      
      language: [<span class="hljs-string">'preprocess'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">next, results</span>) </span>{
        
        scope.detect_language.call(scope, results.preprocess, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
          
          next(err, data);
          
        });
          
      }],
      
      parse_lines: [<span class="hljs-string">'split_lines'</span>, <span class="hljs-string">'language'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">next, results</span>) </span>{

        scope.parse_lines.call(scope, results.split_lines, results.language, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
          
          next(err, data);
          
        });
          
      }],
      
      generate: [<span class="hljs-string">'parse_lines'</span>, <span class="hljs-string">'language'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">next, results</span>) </span>{
        
        scope.generate_output.call(scope, results.parse_lines, results.language, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{

          scope.html = data;
          
          next(err, data);
          
        });
          
      }],
      
      write: [<span class="hljs-string">'generate'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">next, results</span>) </span>{
        
        scope.write.call(scope, results.generate, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{

          next(err, data);
          
        });
          
      }]
      
    }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, results</span>) </span>{
      callback(err, scope);
    });
    
  },

  parse: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
    <span class="hljs-keyword">var</span> scope = <span class="hljs-keyword">this</span>;
    
    fs.readFile(<span class="hljs-keyword">this</span>.filename, <span class="hljs-string">'utf8'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
      scope.parse_file.call(scope, err, data, callback);
    });

  },

</code></pre>
        </div>
        
      </section>
      <section class="section">
        
        <aside class="comment">
          <div class="text markdown"><p>And call the above functions. (This is separate so I can split
out &quot;parsing&quot; and &quot;running&quot; in the near future, to allow
inter-file linking, etc.)</p>
</div>
        </aside>

        <div class="code">
          <pre><code>  run: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
    <span class="hljs-keyword">this</span>.parse(callback);
  }
  
});

</code></pre>
        </div>
        
      </section>
      
      <section class="section footer" id="footer">
        
        <aside class="comment">
          <span class="project-copyright">&copy; Copyright 2016 ZLSA Design.</span>
        </aside>

        <div class="code">
          <span class="page-generation-time">Generated Fri, 11 Mar 2016 21:13:46 GMT</span>
        </div>
        
      </section>
      
    </main>

  </body>
</html>

